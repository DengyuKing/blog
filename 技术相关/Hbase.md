# Hbase原理

#技术,稀疏,分布式

大数据查询时，为什么select * 的效率很慢？
SQL之group by 原理分析 打造个人IP，组建知识网络。

## 1.Hbase概述

HBASE是一个非关系型数据库。从逻辑使用角度看，HBASE就是一个大的表，包含行，列等概念，可以很方便的使用。
从物理存储看，HBASE是一个Map由键值对构成，不同于普通的Map结构，HBASE是一个稀疏的，分布式的，多维排序的Map。

### 1.1 逻辑视图

- 表（table）
- 行（row）
- 列 （column）
- 时间戳（timestamp）
  支持多版本
- 单元格（cell） value字段
- 列簇
  包含一个后者多个列，与列的关系是1对多的关系，且列簇下的列可以动态扩展。
- 多维稀疏排序分布式Map
  本质上是一个Map，多维表示Key是由多个字段构成(rowkey,列，时间戳等)；稀疏表示对于空值不需要记录，这样做的好处是不需要记录空值的东西，省空间，易于扩展；排序构成HBASE的KV在同一个文件中是有序的，不是按照rowKey排序，而是根据key排序。分布式，这个大的Map分布在各个机器上。

### 1.2 物理视图

这里主要分清楚数据库的三种存储模式，行存储，列存储和HBASE的列簇存储。磁盘的存储是线性存储，通过不断追加的方式把数据存入磁盘。

- 行存储
  以行为单位进行数据的读取和存入。以行为单位的读取和存入具有很好的关联性，可以很方便的读取行中的某一列。
- 列存储
  以列为单位进行数据的读取和存入。以列为单位可以很好的分析列的统计数据，当读取多个列的时候，需要访问磁盘多次。
- 列簇存储
  以列簇为单位的扩展，当列簇包含多个列时，此时变为以行为单位的存储，当列簇只包含一个列时，此时变为以列为单位的存储，配置相对来说很灵活。

### 1.3 体系结构

- Master-Slave模型
- HBASE客户端
  - Shell客户端
  - JAVA API
  - MapReduce
- Zookeeper
  - Master高可用
  - 核心元数据
  - 宕机恢复
  - 分布式表锁
- Master
  - 管理请求
  - 管理RegionServer
  - 清理过期文件
- ResionServer
  - Hlog 
  - BlockCache读缓存
  - Region数据表的分片(分片的步骤需要了解一下)
    - store 
      - memStore
      - HFile

### 1.4 系统特性

- 优点
  - 容量大,单表千亿级行，百万列的数据，容量科大TB至PB
  - 扩展性 存储节点扩展（HDFSDataNode）和读写服务扩展（RegionServer）
  - 稀疏性
  - 高新能，写操作好，单点和小范围扫描读好。
  - 多版本
  - 支持过期，类似于Redis.
- 缺点
  - 不支持聚合Join，GroupBy等
  - 不支持二级索引
  - 不支持全局跨行事务，支持单行事务模型

## 2.数据结构与算法

## 3.HBASE依赖服务

## 4.客户端

  客户端是干啥的？有啥作用
  客户端如何根据rowKey确定对应的Region，MetaData里只有startRow，仅仅是startRow怎么定位Region呢？二分查找法吗？

  定位Meta表，定位RowKey
  Scan的过程，涉及到网络，网络会对传输的结果有限制，根据不同的限制，可以采取不同的策略。
  Scan的过程中，根据传输结果集的大小，需要对客户端接收到的结果进行重新排列。
  
## 5.RegionServer核心模块
  Hlog
  LSM 树（日志结构合并树）
  MemStore 
   - 结构
   - GC 本地分配内存，线程本地分配内存  chunk Pool
- Hfile
- 缓存
  - LRU cache的优缺点，不分层效率不高， 缓存分层 为什么要进行缓存分层？ 内存常驻内存会让Java内存从yong到old区域，对象被丢弃时产生碎片。
  - slabCache使用堆外内存把缓存按8：2的比例分配，其中8为存储64Kblock,2为存储128Kblock.由于只能存储这两种规格的block，所以应用很局限。
  - bucketCache 可以配置三种模式，Java Heap，堆外内存和file（类似SSD介质存储），slabCache只能申请两种规格的缓存，且某种内存不够用时，可以借用其他规格的内存，达到不浪费内存。这里介绍堆外内存和Java heap内存的区别，heap是申请的时候经过操作系统分配，然后复制到Java heap,但读取性能快；*堆外内存分配的时候由操作系统直接分配，但是读取的时候，需要先拷贝到Java heap后，才能被访问？？？*。


## 6.Hbase读写流程

## 7.Compaction实现

compaction操作为了弥补LSM树的小文件多的缺点，但是compaction的过程会对查询性能带来影响。
- 减少小文件的个数，提高IO效率
- 提高文件本地化率,什么是文件本地化率？
- 幂等问题往往需要状态机实现，定义好状态的含义和状态之间的转换，从而实现幂等问题，实现容错问题。

## 8.负载均衡实现

## 9.宕机恢复原理

## 10.复制

## 11.备份与修复

## 12.HBASE运维

## 13.HBASE系统调优

## 14.运维案例

## 15.2.x核心技术

## 16.高级话题
